name: Sync with Upstream LLVM

on:
  schedule:
    # Run daily at 1 AM UTC
    - cron: '0 1 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: riscv-software
        fetch-depth: 0  # Full history needed for merge
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"

    - name: Add upstream remote
      run: |
        git remote add upstream https://github.com/llvm/llvm-project.git || true
        git remote set-url upstream https://github.com/llvm/llvm-project.git

    - name: Fetch upstream changes
      run: |
        git fetch upstream main
        git fetch upstream --tags

    - name: Check for new commits
      id: check_commits
      run: |
        # Get the latest upstream commit
        UPSTREAM_COMMIT=$(git rev-parse upstream/main)
        
        # Check if this commit already exists in our branch
        if git merge-base --is-ancestor $UPSTREAM_COMMIT HEAD; then
          echo "No new commits to sync"
          echo "sync_needed=false" >> $GITHUB_OUTPUT
        else
          echo "New commits found, sync needed"
          echo "sync_needed=true" >> $GITHUB_OUTPUT
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
        fi

    - name: Merge upstream changes
      if: steps.check_commits.outputs.sync_needed == 'true'
      run: |
        # Get the short commit hash for the commit message
        SHORT_HASH=$(git rev-parse --short ${{ steps.check_commits.outputs.upstream_commit }})
        
        # Attempt to merge upstream changes
        if git merge upstream/main --no-edit; then
          # If merge successful, update the commit message
          git commit --amend -m "Automerge: Sync with upstream LLVM ($SHORT_HASH)"
          echo "Merge successful"
        else
          echo "Merge conflicts detected"
          git merge --abort
          
          # Create an issue for manual intervention
          echo "MERGE_FAILED=true" >> $GITHUB_ENV
          echo "CONFLICT_COMMIT=$SHORT_HASH" >> $GITHUB_ENV
        fi

    - name: Push changes
      if: steps.check_commits.outputs.sync_needed == 'true' && env.MERGE_FAILED != 'true'
      run: |
        git push origin riscv-software

    - name: Create issue for merge conflicts
      if: env.MERGE_FAILED == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Automerge failed: Merge conflict with upstream LLVM (${process.env.CONFLICT_COMMIT})`,
            body: `The automated sync with upstream LLVM failed due to merge conflicts.
            
            **Upstream commit:** ${process.env.CONFLICT_COMMIT}
            **Branch:** riscv-software
            
            Manual intervention is required to resolve the conflicts.
            
            To resolve:
            1. \`git fetch upstream main\`
            2. \`git merge upstream/main\`
            3. Resolve conflicts
            4. \`git commit\`
            5. \`git push origin riscv-software\`
            `,
            labels: ['automerge-conflict', 'needs-attention']
          })

    - name: Notify on success
      if: steps.check_commits.outputs.sync_needed == 'true' && env.MERGE_FAILED != 'true'
      run: |
        echo "Successfully synced with upstream LLVM"
        echo "New commits merged into riscv-software branch"
